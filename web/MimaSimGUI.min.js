TLN.append_line_numbers("source_code");const MimaElementID=Object.freeze({IR:1,IAR:2,TRA:3,RUN:4,SIR:5,SAR:6,ACC:7,X:8,Y:9,Z:10,ALU:11,MICRO_CYCLE:12,ONE:13,IMMEDIATE:14,MEMORY:15,IOMEMORY:16});var runTimerID,mima_instance,MimaModel={IR:0,IAR:0,TRA:0,RUN:1,SIR:0,SAR:0,ACC:0,X:0,Y:0,Z:0,ALU:0,MICRO_CYCLE:1,ONE:1},memoryLineMap=new Map,running=!1;function resetMimaModel(){MimaModel={IR:0,IAR:0,TRA:0,RUN:1,SIR:0,SAR:0,ACC:0,X:0,Y:0,Z:0,ALU:-1,MICRO_CYCLE:1,ONE:1};var e=document.getElementById("mimaimg").contentDocument;e.getElementById("ir_text").innerHTML=getHexString(MimaModel.IR),e.getElementById("iar_text").innerHTML=getHexString(MimaModel.IAR),e.getElementById("tra_label").setAttribute("fill","#ffaaaa"),e.getElementById("run_label").setAttribute("fill","#ffaaaa"),e.getElementById("sir_text").innerHTML=getHexString(MimaModel.SIR),e.getElementById("sar_text").innerHTML=getHexString(MimaModel.SAR),e.getElementById("acc_text").innerHTML=getHexString(MimaModel.ACC),e.getElementById("x_text").innerHTML=getHexString(MimaModel.X),e.getElementById("y_text").innerHTML=getHexString(MimaModel.Y),e.getElementById("z_text").innerHTML=getHexString(MimaModel.Z),e.getElementById("alu_text").innerHTML=getOpCodeName(MimaModel.ALU),e.getElementById("counter_text").innerHTML=MimaModel.MICRO_CYCLE}function getHexString(e){return e<0&&(e=4294967295+e+1),"0x"+("00000000"+e.toString(16).toUpperCase()).substr(-8)}function getOpCodeName(e){switch(e){case-1:return"ALU";case 0:return"ADD";case 1:return"AND";case 2:return"OR";case 3:return"XOR";case 4:return"LDV";case 5:return"STV";case 6:return"LDC";case 7:return"JMP";case 8:return"JMN";case 9:return"EQL";case 240:return"HLT";case 241:return"NOT";case 242:return"RAR";case 243:return"RRN"}}function setHalted(){document.getElementById("btn_run").value="Run",document.getElementById("btn_run").disabled=!0,document.getElementById("btn_step").disabled=!0,document.getElementById("btn_mstep").disabled=!0,document.getElementById("btn_reset").disabled=!1,document.getElementById("btn_show_mem").disabled=!1,running=!1,runTimerID&&clearInterval(runTimerID)}function hitBreakpoint(){document.getElementById("btn_run").value="Run",document.getElementById("btn_run").disabled=!1,document.getElementById("btn_step").disabled=!1,document.getElementById("btn_mstep").disabled=!1,document.getElementById("btn_reset").disabled=!1,document.getElementById("btn_show_mem").disabled=!1,document.getElementById("current_line").setAttribute("style","background:#eeaaff;"),running=!1,runTimerID&&clearInterval(runTimerID)}function resetMimaGUI(){var e=document.getElementById("mimaimg").contentDocument;e.getElementById("darrow_ir_bus").setAttribute("visibility","visible"),e.getElementById("darrow_iar_bus").setAttribute("visibility","visible"),e.getElementById("darrow_sir_bus").setAttribute("visibility","visible"),e.getElementById("darrow_sar_bus").setAttribute("visibility","visible"),e.getElementById("darrow_sir_mem").setAttribute("visibility","visible"),e.getElementById("darrow_sir_iobus").setAttribute("visibility","visible"),e.getElementById("darrow_acc_bus").setAttribute("visibility","visible"),e.getElementById("arrow_bus_acc").setAttribute("visibility","hidden"),e.getElementById("arrow_acc_bus").setAttribute("visibility","hidden"),e.getElementById("arrow_ir_bus").setAttribute("visibility","hidden"),e.getElementById("arrow_bus_ir").setAttribute("visibility","hidden"),e.getElementById("arrow_iar_bus").setAttribute("visibility","hidden"),e.getElementById("arrow_bus_iar").setAttribute("visibility","hidden"),e.getElementById("arrow_sir_bus").setAttribute("visibility","hidden"),e.getElementById("arrow_bus_sir").setAttribute("visibility","hidden"),e.getElementById("arrow_sar_bus").setAttribute("visibility","hidden"),e.getElementById("arrow_bus_sar").setAttribute("visibility","hidden"),e.getElementById("arrow_sir_mem").setAttribute("visibility","hidden"),e.getElementById("arrow_mem_sir").setAttribute("visibility","hidden"),e.getElementById("arrow_sir_iobus").setAttribute("visibility","hidden"),e.getElementById("arrow_iobus_sir").setAttribute("visibility","hidden"),e.getElementById("bus").setAttribute("style","fill:#ffffff;stroke:#000000;stroke-dasharray:none"),e.getElementById("iobus").setAttribute("style","fill:#ffffff;stroke:#000000;stroke-dasharray:none"),e.getElementById("mem_color").setAttribute("style","fill:#e1d5e7;stroke:#9673a6;stroke-width:2;stroke-miterlimit:10"),e.getElementById("alu_shape").setAttribute("style","fill:#bfbfbf;stroke:#4c4c4c;stroke-width:0;stroke-linecap:round;stroke-linejoin:round;stroke-dasharray:none"),e.getElementById("arrow_bus_x").setAttribute("style","fill:#ffffff;stroke:#000000;stroke-miterlimit:10"),e.getElementById("arrow_bus_y").setAttribute("style","fill:#ffffff;stroke:#000000;stroke-miterlimit:10"),e.getElementById("arrow_x_alu").setAttribute("style","fill:#ffffff;stroke:#000000;stroke-miterlimit:10"),e.getElementById("arrow_y_alu").setAttribute("style","fill:#ffffff;stroke:#000000;stroke-miterlimit:10"),e.getElementById("arrow_alu_z").setAttribute("style","fill:#ffffff;stroke:#000000;stroke-miterlimit:10"),e.getElementById("arrow_z_bus").setAttribute("style","fill:#ffffff;stroke:#000000;stroke-miterlimit:10"),e.getElementById("arrow_one_bus").setAttribute("style","fill:#ffffff;stroke:#000000;stroke-miterlimit:10"),e.getElementById("arrow_sar_iobus").setAttribute("style","fill:#ffffff;stroke:#000000;stroke-miterlimit:10"),e.getElementById("arrow_sar_mem").setAttribute("style","fill:#ffffff;stroke:#000000;stroke-miterlimit:10"),e.getElementById("alu_text").innerHTML="ALU",e.getElementById("counter_text").innerHTML="1"}function updateMimaState(e,t,i){var r=document.getElementById("mimaimg").contentDocument;switch(t){case 1:MimaModel.IR=i,r.getElementById("ir_text").innerHTML=getHexString(i),r.getElementById("darrow_ir_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_bus_ir").setAttribute("visibility","visible"),r.getElementById("darrow_sir_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_sir_bus").setAttribute("visibility","visible"),r.getElementById("bus").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-dasharray:none");break;case 2:MimaModel.IAR=i,r.getElementById("iar_text").innerHTML=getHexString(i);let s=memoryLineMap.get(i);if(!s)break;var n=document.getElementById("current_line");n&&(n.setAttribute("style","background:#ffffff;"),n.removeAttribute("id")),document.querySelector(".tln-wrapper :nth-child("+s+")").setAttribute("style","background:#eeeeff;"),document.querySelector(".tln-wrapper :nth-child("+s+")").setAttribute("id","current_line"),e==MimaElementID.IR&&(r.getElementById("darrow_ir_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_ir_bus").setAttribute("visibility","visible")),e==MimaElementID.Z&&r.getElementById("arrow_z_bus").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-miterlimit:10"),r.getElementById("darrow_iar_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_bus_iar").setAttribute("visibility","visible"),r.getElementById("bus").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-dasharray:none");break;case 3:MimaModel.TRA=i,r.getElementById("tra_label").setAttribute("class",i?"active":"inactive");break;case 4:MimaModel.RUN=i,r.getElementById("run_label").setAttribute("class",i?"active":"inactive");break;case 5:MimaModel.SIR=i,r.getElementById("sir_text").innerHTML=getHexString(i),e==MimaElementID.MEMORY&&(r.getElementById("darrow_sir_mem").setAttribute("visibility","hidden"),r.getElementById("arrow_mem_sir").setAttribute("visibility","visible"),r.getElementById("mem_color").setAttribute("style","fill:#aaffaa;stroke:#9673a6;stroke-width:2;stroke-miterlimit:10"),r.getElementById("mem_text").innerHTML="Read done"),e==MimaElementID.IOMEMORY&&(r.getElementById("darrow_sir_iobus").setAttribute("visibility","hidden"),r.getElementById("arrow_iobus_sir").setAttribute("visibility","visible"),r.getElementById("iobus").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-dasharray:none")),e==MimaElementID.ACC&&(r.getElementById("darrow_sir_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_bus_sir").setAttribute("visibility","visible"),r.getElementById("darrow_acc_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_acc_bus").setAttribute("visibility","visible"),r.getElementById("bus").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-dasharray:none"));break;case 6:MimaModel.SAR=i,r.getElementById("sar_text").innerHTML=getHexString(i),r.getElementById("darrow_sar_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_bus_sar").setAttribute("visibility","visible"),r.getElementById("bus").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-dasharray:none"),e==MimaElementID.IR&&(r.getElementById("darrow_ir_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_ir_bus").setAttribute("visibility","visible")),e==MimaElementID.IAR&&(r.getElementById("darrow_iar_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_iar_bus").setAttribute("visibility","visible")),i>201326592?r.getElementById("arrow_sar_iobus").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-miterlimit:10"):(r.getElementById("arrow_sar_mem").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-miterlimit:10"),r.getElementById("mem_color").setAttribute("style","fill:#aaffaa;stroke:#9673a6;stroke-width:2;stroke-miterlimit:10"),r.getElementById("mem_text").innerHTML="waiting...");break;case 7:MimaModel.ACC=i,r.getElementById("acc_text").innerHTML=getHexString(i),r.getElementById("darrow_acc_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_bus_acc").setAttribute("visibility","visible"),r.getElementById("bus").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-dasharray:none"),e==MimaElementID.IR&&(r.getElementById("darrow_ir_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_ir_bus").setAttribute("visibility","visible")),e==MimaElementID.SIR&&(r.getElementById("darrow_sir_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_sir_bus").setAttribute("visibility","visible")),e==MimaElementID.Z&&r.getElementById("arrow_z_bus").setAttribute("visibility","visible");break;case 8:MimaModel.X=i,r.getElementById("x_text").innerHTML=getHexString(i),r.getElementById("arrow_bus_x").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-miterlimit:10"),r.getElementById("bus").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-dasharray:none"),e==MimaElementID.ACC&&(r.getElementById("darrow_acc_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_bus_acc").setAttribute("visibility","visible")),e==MimaElementID.IAR&&(r.getElementById("darrow_iar_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_iar_bus").setAttribute("visibility","visible"));break;case 9:MimaModel.Y=i,r.getElementById("y_text").innerHTML=getHexString(i),r.getElementById("arrow_bus_y").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-miterlimit:10"),r.getElementById("bus").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-dasharray:none"),e==MimaElementID.IR&&(r.getElementById("darrow_ir_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_ir_bus").setAttribute("visibility","visible")),e==MimaElementID.SIR&&(r.getElementById("darrow_sir_bus").setAttribute("visibility","hidden"),r.getElementById("arrow_sir_bus").setAttribute("visibility","visible")),e==MimaElementID.ONE&&r.getElementById("arrow_one_bus").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-miterlimit:10");break;case 10:MimaModel.Z=i,r.getElementById("z_text").innerHTML=getHexString(i),r.getElementById("arrow_alu_z").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-miterlimit:10"),r.getElementById("arrow_x_alu").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-miterlimit:10"),r.getElementById("arrow_y_alu").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-miterlimit:10"),r.getElementById("alu_shape").setAttribute("style","fill:#aaffaa;stroke:#4c4c4c;stroke-width:0;stroke-linecap:round;stroke-linejoin:round;stroke-dasharray:none");break;case 11:MimaModel.ALU=i,r.getElementById("alu_text").innerHTML=getOpCodeName(i),r.getElementById("alu_shape").setAttribute("style","fill:#aaffaa;stroke:#4c4c4c;stroke-width:0;stroke-linecap:round;stroke-linejoin:round;stroke-dasharray:none");break;case 12:MimaModel.MICRO_CYCLE=i,r.getElementById("counter_text").innerHTML=i;break;case 15:r.getElementById("darrow_sir_mem").setAttribute("visibility","hidden"),r.getElementById("arrow_sir_mem").setAttribute("visibility","visible"),r.getElementById("mem_color").setAttribute("style","fill:#aaffaa;stroke:#9673a6;stroke-width:2;stroke-miterlimit:10");break;case 16:r.getElementById("iobus").setAttribute("style","fill:#aaffaa;stroke:#000000;stroke-dasharray:none"),e==MimaElementID.SIR&&(r.getElementById("darrow_sir_iobus").setAttribute("visibility","hidden"),r.getElementById("arrow_sir_iobus").setAttribute("visibility","visible"))}}Module.onRuntimeInitialized=(async e=>{mima_instance=_mima_init(),_mima_wasm_set_run(mima_instance,!1),document.getElementById("btn_step").disabled=!0,document.getElementById("btn_mstep").disabled=!0,document.getElementById("btn_run").disabled=!0,document.getElementById("btn_reset").disabled=!0,document.getElementById("btn_show_mem").disabled=!0,document.getElementById("btn_compile").onclick=async function(){memoryLineMap.clear();var e=document.getElementById("source_code").value,t=allocate(intArrayFromString(e),"i8",ALLOC_NORMAL);_mima_compile_s(mima_instance,t)?(document.getElementById("btn_step").disabled=!1,document.getElementById("btn_mstep").disabled=!1,document.getElementById("btn_run").disabled=!1,document.getElementById("btn_reset").disabled=!1,document.getElementById("btn_compile").disabled=!0,document.getElementById("btn_show_mem").disabled=!1):(document.getElementById("btn_step").disabled=!0,document.getElementById("btn_mstep").disabled=!0,document.getElementById("btn_run").disabled=!0,document.getElementById("btn_reset").disabled=!0,document.getElementById("btn_compile").disabled=!1,document.getElementById("btn_show_mem").disabled=!0),_mima_wasm_free(t)},document.getElementById("btn_step").onclick=async function(){_mima_run_instruction_step(mima_instance),_mima_wasm_set_run(mima_instance,!1),resetMimaGUI()},document.getElementById("btn_mstep").onclick=async function(){resetMimaGUI(),_mima_wasm_set_run(mima_instance,!0),_mima_run_micro_instruction_step(mima_instance),_mima_wasm_set_run(mima_instance,!1)},document.getElementById("btn_run").onclick=async function(){if(running)running=!1,runTimerID&&clearInterval(runTimerID),_mima_wasm_set_run(mima_instance,!1),document.getElementById("btn_run").value="Run",document.getElementById("btn_step").disabled=!1,document.getElementById("btn_mstep").disabled=!1,document.getElementById("btn_reset").disabled=!1,document.getElementById("btn_show_mem").disabled=!1;else{running=!0,resetMimaGUI(),_mima_wasm_set_run(mima_instance,!0),runTimerID=setInterval(function(){resetMimaGUI(),_mima_run_micro_instruction_step(mima_instance)},10),document.getElementById("btn_run").value="Pause",document.getElementById("btn_step").disabled=!0,document.getElementById("btn_mstep").disabled=!0,document.getElementById("btn_reset").disabled=!0}},document.getElementById("btn_reset").onclick=function(){document.getElementById("btn_reset").disabled=!0,document.getElementById("btn_compile").disabled=!1,document.getElementById("btn_step").disabled=!0,document.getElementById("btn_mstep").disabled=!0,document.getElementById("btn_run").disabled=!0,document.getElementById("btn_show_mem").disabled=!0;var e=document.getElementById("current_line");e&&(e.setAttribute("style","background:#ffffff;"),e.removeAttribute("id")),resetMimaModel(),resetMimaGUI(),_mima_delete(mima_instance),mima_instance=_mima_init(),_mima_wasm_set_run(mima_instance,!1),_mima_wasm_set_log_level(2),document.getElementById("ll_info").checked=!0,document.getElementById("log_text").innerHTML="",document.getElementById("output_text").innerHTML="",runTimerID&&clearInterval(runTimerID)},document.getElementById("btn_show_mem").onclick=function(){var e=document.getElementById("mem_add").value;_mima_wasm_to_memorydump(mima_instance,parseInt(e,0))},document.getElementById("source_code").onchange=function(){var e=document.getElementById("compile_error");e&&(e.setAttribute("style","background:#ffffff"),e.removeAttribute("id"))};for(var t=document.forms.loglevel_radio_form,i=null,r=0;r<t.length;++r)t[r].addEventListener("change",function(){switch(this!==i&&(i=this),this.value){case"TRACE":_mima_wasm_set_log_level(0);break;case"INFO":_mima_wasm_set_log_level(2);break;case"WARN":_mima_wasm_set_log_level(3)}});_mima_wasm_set_log_level(2),document.getElementById("ll_info").checked=!0,resetMimaGUI()})